###############################################################################
# To enable this flavor, add it to the builder.conf `BUILDER_PLUGINS`:
#   BUILDER_PLUGINS += whonix
###############################################################################

# Uncomment to enable the `+whonix` template flavor
# BUILDER_PLUGINS += template-whonix

################################################################################
#                           S E L F   N A M E
################################################################################
_self := $(strip $(lastword 1,$(subst /, ,$(dir $(lastword $(MAKEFILE_LIST))))))

################################################################################
#                     L I S T   O F   D I S T   V M ' S
################################################################################
# List of all build template variations that will be offered in the 'setup'
# DISTS_VM dialog to be able to choose from
#
# Available template flavors may be added the the template build by appending
# `+flavor_name`
ifeq "$(SETUP_MODE)" "1"
  DISTS_VM += whonix-gateway
  DISTS_VM += whonix-gateway+minimal
  DISTS_VM += whonix-workstation
  DISTS_VM += whonix-workstation+gnome
endif

################################################################################
#                     T E M P L A T E   A L I A S 
################################################################################
# TEMPLATE_ALIAS can be used to choose a shorter name in DISTS_VM that
# include some other TEMPLATE_FLAVORs.  A TEMPLATE_LABEL will automatically
# be created if one does not exist that will use the alias name as the 
# tempalte name.  Plus signs (+) will be converted to hyphens (-).
TEMPLATE_ALIAS += whonix-gateway:wheezy+whonix-gateway+standard
TEMPLATE_ALIAS += whonix-gateway+minimal:wheezy+whonix-gateway+minimal
TEMPLATE_ALIAS += whonix-workstation:wheezy+whonix-workstation+standard
TEMPLATE_ALIAS += whonix-workstation+gnome:wheezy+whonix-workstation+gnome+standard

################################################################################
#                 T E M P L A T E   C O N F I G U R A T I O N
################################################################################
# TEMPLATE_LABEL allows control over the final template name.  There is a limit
# of 31 characters for the final template name
# 
# TEMPLATE_LABE += <DIST_VM name as listed above>:<desired final template name>
TEMPLATE_LABEL += wheezy+whonix-gateway+standard:whonix-gw-experimental
TEMPLATE_LABEL += wheezy+whonix-gateway+minimal:whonix-gw-experimental-minimal
TEMPLATE_LABEL += wheezy+whonix-workstation+standard:whonix-ws
TEMPLATE_LABEL += wheezy+whonix-workstation+gnome+standard:whonix-ws-gnome

$(strip $(foreach _alias, $(TEMPLATE_ALIAS), $(_aliases)))

################################################################################
#                              W H O N I X
################################################################################
INCLUDED := 1
-include $(SRC_DIR)/$(_self)/Makefile

# ------------------------------------------------------------------------------
# Define flavor directory location (here)
# ------------------------------------------------------------------------------
WHONIX_DIR = $(shell readlink -m .)/$(SRC_DIR)/Whonix
TEMPLATE_FLAVOR_DIR += +whonix-workstation:$(shell readlink -m .)/$(SRC_DIR)/$(_self)

# ------------------------------------------------------------------------------
# Add builder-debian PLUGIN if it's not already added
# ------------------------------------------------------------------------------
ifeq (,$(findstring builder-debian, $(BUILDER_PLUGINS)))
  BUILDER_PLUGINS += builder-debian
  COMPONENTS := $(COMPONENTS) $(_components)
endif

# ------------------------------------------------------------------------------
# Add / Remove Whonix components based on if Whonix is being built
# ------------------------------------------------------------------------------
ifneq (,$(findstring wheezy+whonix, $(DISTS_VM)))
  WHONIX := 1
  COMPONENTS := $(strip $(COMPONENTS) $(WHONIX_COMPONENTS))
  TEMPLATE := $(strip $(TEMPLATE) $(WHONIX_COMPONENTS))
else
  COMPONENTS := $(strip $(filter-out $(WHONIX_COMPONENTS), $(COMPONENTS)))
  TEMPLATE := $(strip $(filter-out $(WHONIX_COMPONENTS), $(TEMPLATE)))
endif

# ------------------------------------------------------------------------------
# Get rid of quotes
# ------------------------------------------------------------------------------
WHONIX_DIR := $(shell echo $(WHONIX_DIR))


.PHONY: patch
patch::
	# Move a generic Makefile.builder over to non-qubes packages so they can be
	# built with qubes-builder
	@echo "Applying pathces..."; \
	repos=$(addprefix $(shell readlink -m ./$(SRC_DIR))/,"whonix-setup-wizard python-guimessages qubes-whonix"); \
	for repo in $$repos; do \
	    if [ -d "$$repo" ]; then \
	            echo "Applying whonix related patches to $$repo..."; \
	            cp -pf $(shell readlink -m ./$(SRC_DIR))/template-whonix/scripts/Makefile.builder $$repo ; \
	    fi \
	done;


about::
	@echo "template-whonix/builder.conf"

# vim: filetype=make
