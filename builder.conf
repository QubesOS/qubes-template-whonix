###############################################################################
# To enable this flavor, add it to the builder.conf `BUILDER_PLUGINS`:
#   BUILDER_PLUGINS += whonix
###############################################################################

# Uncomment to enable the `+whonix` template flavor
# BUILDER_PLUGINS += template-whonix

################################################################################
# Extra Whonix Build Options
################################################################################
# Use turbo mode to build template
BUILDER_TURBO_MODE ?= 1

# Enable Tor by default (0: disable; 1: enable)
WHONIX_ENABLE_TOR ?= 0

# Install Tor browser by default (0: disable; 1: enable)
WHONIX_INSTALL_TB ?= 1

# Custom Tor browser installation directory (path must be absolute)
# (leave blank or commented out fordefault location)
#WHONIX_INSTALL_TB_DIRECTORY ?= /home/user

# Un-comment to create separate build log
#WHONIX_BUILD_LOG := $(BUILDER_DIR)/build-logs/$(DIST).log

################################################################################
#                           S E L F   N A M E
################################################################################
_self := $(strip $(lastword 1,$(subst /, ,$(dir $(lastword $(MAKEFILE_LIST))))))

################################################################################
#                     L I S T   O F   D I S T   V M ' S
################################################################################
# List of all build template variations that will be offered in the 'setup'
# DISTS_VM dialog to be able to choose from
#
# Available template flavors may be added the the template build by appending
# `+flavor_name`
ifeq "$(SETUP_MODE)" "1"
  DISTS_VM += whonix-gateway
  DISTS_VM += whonix-gateway+minimal
  DISTS_VM += whonix-workstation
  DISTS_VM += whonix-workstation+gnome
endif

################################################################################
#                     T E M P L A T E   A L I A S 
################################################################################
# TEMPLATE_ALIAS can be used to choose a shorter name in DISTS_VM that
# include some other TEMPLATE_FLAVORs.  A TEMPLATE_LABEL will automatically
# be created if one does not exist that will use the alias name as the 
# tempalte name.  Plus signs (+) will be converted to hyphens (-).
TEMPLATE_ALIAS += whonix-gateway:jessie+whonix-gateway+standard
TEMPLATE_ALIAS += whonix-gateway+minimal:jessie+whonix-gateway+minimal
TEMPLATE_ALIAS += whonix-workstation:jessie+whonix-workstation+standard
TEMPLATE_ALIAS += whonix-workstation+gnome:jessie+whonix-workstation+gnome+standard

################################################################################
#                 T E M P L A T E   C O N F I G U R A T I O N
################################################################################
# TEMPLATE_LABEL allows control over the final template name.  There is a limit
# of 31 characters for the final template name
# 
# TEMPLATE_LABE += <DIST_VM name as listed above>:<desired final template name>
TEMPLATE_LABEL += jessie+whonix-gateway+standard:whonix-gw
TEMPLATE_LABEL += jessie+whonix-gateway+minimal:whonix-gw-minimal
TEMPLATE_LABEL += jessie+whonix-workstation+standard:whonix-ws
TEMPLATE_LABEL += jessie+whonix-workstation+gnome+standard:whonix-ws-gnome

$(strip $(foreach _alias, $(TEMPLATE_ALIAS), $(_aliases)))

################################################################################
#                              W H O N I X
################################################################################
-include $(BUILDER_DIR)/$(SRC_DIR)/$(_self)/components.conf

# ------------------------------------------------------------------------------
# Define flavor directory location (here)
# ------------------------------------------------------------------------------
WHONIX_DIR := $(BUILDER_DIR)/$(SRC_DIR)/Whonix
APPMENUS_DIR := $(BUILDER_DIR)/$(SRC_DIR)/$(_self)
TEMPLATE_FLAVOR_DIR += +whonix-gateway:$(BUILDER_DIR)/$(SRC_DIR)/$(_self)
TEMPLATE_FLAVOR_DIR += +whonix-workstation:$(BUILDER_DIR)/$(SRC_DIR)/$(_self)

# ------------------------------------------------------------------------------
# Add builder-debian PLUGIN if it's not already added
# ------------------------------------------------------------------------------
ifeq (,$(findstring builder-debian, $(BUILDER_PLUGINS)))
  BUILDER_PLUGINS += builder-debian
  COMPONENTS := $(COMPONENTS) $(_components)
endif

# ------------------------------------------------------------------------------
# Add / Remove Whonix components based on if Whonix is being built
# ------------------------------------------------------------------------------
ifneq (,$(findstring jessie+whonix, $(DISTS_VM)))
  # Insert genmkfile before qubes-whonix
  WHONIX_COMPONENTS := $(strip $(filter-out genmkfile, $(WHONIX_COMPONENTS)))
  WHONIX_COMPONENTS := $(strip $(patsubst qubes-whonix, genmkfile qubes-whonix, $(WHONIX_COMPONENTS)))

  WHONIX := 1
  COMPONENTS := $(strip $(COMPONENTS) $(WHONIX_COMPONENTS))
  TEMPLATE := $(strip $(TEMPLATE) $(WHONIX_COMPONENTS))
else
  COMPONENTS := $(strip $(filter-out $(WHONIX_COMPONENTS), $(COMPONENTS)))
  TEMPLATE := $(strip $(filter-out $(WHONIX_COMPONENTS), $(TEMPLATE)))
endif

.PHONY: patch
patch::	_repos = $(addprefix $(BUILDER_DIR)/$(SRC_DIR)/, qubes-whonix genmkfile)
patch::
	# Move a generic Makefile.builder over to non-qubes packages so they can be
	# built with qubes-builder
	@echo "Applying patches..."; \
	for repo in $(_repos); do \
	    if [ -d "$$repo" ]; then \
	            echo "Applying whonix related patches to $$repo..."; \
	            cp -pf $(BUILDER_DIR)/$(SRC_DIR)/template-whonix/scripts/Makefile.builder $$repo ; \
	    fi \
	done

qubes-vm:: patch
qubes-vm:: 
	@true

about::
	@echo "template-whonix/builder.conf"

# vim: filetype=make
